<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>랜덤 퀴즈</title>

<style>
  body { 
    font-family: Arial, sans-serif; 
    text-align: center;

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;

    height: 100vh;
    margin: 0;
  }

  #quizBox { 
    font-size: 22px; 
    margin-bottom: 20px; 
    white-space: pre-wrap; 
    max-width: 600px;
  }

  button { 
    padding: 12px 20px; 
    font-size: 18px; 
    margin: 10px; 
    cursor: pointer; 
  }

  #answerBox { 
    margin-top: 20px; 
    font-size: 20px; 
    color: #444; 
    white-space: pre-wrap; 
    max-width: 600px;
  }

  #counter {
    margin-top: 20px;
    font-size: 16px;
    color: #666;
  }

  /* 모달 스타일 */
  #modalOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.45);
    justify-content: center;
    align-items: center;
  }

  #modalBox {
    background: white;
    width: 80%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
    text-align: left;
  }

  #modalBox h2 {
    text-align: center;
  }
</style>
</head>

<body>

<h1>랜덤 퀴즈</h1>
<div id="quizBox">문제를 불러오는 중...</div>

<button id="mainBtn">정답 보기</button>
<button id="wrongNoteBtn">오답노트 보기</button>

<div id="answerBox"></div>

<div id="counter">푼 문제 수: 0</div>

<!-- 오답노트 모달 -->
<div id="modalOverlay">
  <div id="modalBox">
    <h2>오답노트 (최근 7일)</h2>
    <div id="wrongList"></div>
    <div style="text-align:center;">
      <button onclick="closeModal()">닫기</button>
    </div>
  </div>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/16VxOkZhO-TgUWYdQ0BGyGhBR5MKUvyb9Mo6lv4UVx0Q/export?format=csv";

function smartParseCSV(text) {
  text = text.replace(/\r/g, "");
  const rows = [];
  let current = [];
  let insideQuotes = false;
  let value = "";

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i + 1];

    if (c === '"' && next === '"') {
      value += '"';
      i++;
    } else if (c === '"') {
      insideQuotes = !insideQuotes;
    } else if (c === ',' && !insideQuotes) {
      current.push(value);
      value = "";
    } else if (c === '\n' && !insideQuotes) {
      current.push(value);
      rows.push(current);
      current = [];
      value = "";
    } else {
      value += c;
    }
  }

  if (value || current.length) {
    current.push(value);
    rows.push(current);
  }

  return rows;
}

let quizData = [];
let current = null;
let showingAnswer = false;
let solvedCount = 0;

function todayKey() {
  return new Date().toISOString().slice(0, 10);
}

function loadWrongNotes() {
  return JSON.parse(localStorage.getItem("wrongNotes") || "{}");
}

function saveWrongNotes(obj) {
  localStorage.setItem("wrongNotes", JSON.stringify(obj));
}

function cleanupOldNotes() {
  let notes = loadWrongNotes();
  const now = new Date();

  for (let day of Object.keys(notes)) {
    const diff = (now - new Date(day)) / (1000 * 60 * 60 * 24);
    if (diff > 7) delete notes[day];
  }
  saveWrongNotes(notes);
}

function addWrongNote(q, a, noteText) {
  let notes = loadWrongNotes();
  const key = todayKey();
  if (!notes[key]) notes[key] = [];
  notes[key].push({ question: q, answer: a, note: noteText });
  saveWrongNotes(notes);
  cleanupOldNotes();
}

function pickRandom() {
  showingAnswer = false;
  current = quizData[Math.floor(Math.random() * quizData.length)];
  quizBox.textContent = current.question;
  answerBox.textContent = "";
  mainBtn.textContent = "정답 보기";
}

mainBtn.onclick = () => {
  if (!showingAnswer) {
    showingAnswer = true;
    answerBox.textContent = `정답: ${current.answer}\n\n비고: ${current.note}`;
    mainBtn.textContent = "다음 문제";
    addWrongNote(current.question, current.answer, current.note);
  } else {
    solvedCount++;
    counter.textContent = `푼 문제 수: ${solvedCount}`;
    pickRandom();
  }
};

wrongNoteBtn.onclick = () => {
  const notes = loadWrongNotes();
  let html = "";
  const days = Object.keys(notes).sort().reverse();

  if (days.length === 0) {
    html = "<p>최근 7일 오답이 없습니다.</p>";
  } else {
    for (let day of days) {
      html += `<h3>${day}</h3>`;
      notes[day].forEach((item, i) => {
        html += `
          <div style="border-bottom:1px solid #ccc; padding:10px 0;">
            <strong>문제 ${i + 1}</strong><br>
            ${item.question}<br><br>
            <strong>정답:</strong> ${item.answer}<br>
            <strong>비고:</strong> ${item.note}
          </div>`;
      });
    }
  }

  wrongList.innerHTML = html;
  modalOverlay.style.display = "flex";
};

function closeModal() {
  modalOverlay.style.display = "none";
}

fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const rows = smartParseCSV(text);
    rows.shift();
    quizData = rows
      .filter(r => r[0])
      .map(r => ({ question: r[0], answer: r[1] || "", note: r[2] || "" }));
    cleanupOldNotes();
    pickRandom();
  })
  .catch(() => {
    quizBox.textContent = "CSV 로딩 실패!";
  });
</script>

</body>
</html>
